<template>
  <div class="simple-report">
    <!-- ‰ΩøÁî® ReportViewer Ê∏≤Êüì Markdown -->
    <ReportViewer 
      ref="reportViewerRef"
      :markdown="markdownContent" 
      :title="reportTitle"
    />
  </div>
</template>

<script setup lang="ts">
import { computed, ref } from 'vue'
import { useI18n } from 'vue-i18n'
import ReportViewer from '@/components/reports/ReportViewer.vue'

const { t } = useI18n()

// Ëé∑Âèñ ReportViewer ÁªÑ‰ª∂ÂºïÁî®
const reportViewerRef = ref()

interface AnalysisThought {
  agent?: string
  thought: string
  timestamp: string
  phase?: string
  phaseName?: string
  isTool?: boolean
  tool?: string
}

interface Analysis {
  id: string
  timestamp: number
  duration: number
  config: {
    symbol: string
    marketType?: string
    depth?: number
  }
  agentThoughts: AnalysisThought[]
}

interface Props {
  analysis: Analysis | null
}

const props = defineProps<Props>()

// Êä•ÂëäÊ†áÈ¢ò
const reportTitle = computed(() => {
  return `${props.analysis?.config?.symbol || ''} ${t('report.reportTitle')}`
})

// ËΩ¨Êç¢‰∏∫ Markdown Ê†ºÂºè
const markdownContent = computed(() => {
  if (!props.analysis?.agentThoughts || props.analysis.agentThoughts.length === 0) {
    return `## ${t('report.analysisProcess')}\n\n> ${t('report.noDataFound')}`
  }

  // ÁîüÊàêÊä•ÂëäÂ§¥ÈÉ®‰ø°ÊÅØ
  const header = `## ${t('report.basicInfo')}

| ${t('report.project')} | ${t('report.value')} |
|------|-----|
| ${t('report.fields.analysisId')} | \`${props.analysis.id?.slice(-8) || 'N/A'}\` |
| ${t('report.fields.analysisTime')} | ${new Date(props.analysis.timestamp).toLocaleString()} |
| ${t('report.fields.analysisDepth')} | ${props.analysis.config?.depth || 1} |
| ${t('report.fields.analysisDuration')} | ${formatDuration(props.analysis.duration)} |

---

## ${t('report.analysisProcess')}

`

  // Â§ÑÁêÜÂàÜÊûêÊ≠•È™§
  const steps = props.analysis.agentThoughts
    .map((thought, index) => {
      const timestamp = new Date(thought.timestamp).toLocaleTimeString()
      const agent = thought.agent || t('common.system')
      const phase = thought.phaseName || thought.phase || ''
      
      // Ê†πÊçÆ‰ª£ÁêÜÁ±ªÂûã‰ΩøÁî®‰∏çÂêåÁöÑÂõæÊ†á
      const agentIcon = getAgentIcon(agent)
      
      return `### ${agentIcon} ${t('report.step')} ${index + 1}: ${agent}${phase ? ` - ${phase}` : ''}

**${t('report.time')}**: \`${timestamp}\`

${formatThoughtContent(thought.thought)}

---`
    })
    .join('\n\n')

  return header + steps + `

## ${t('report.generationInfo')}

> üìÑ ${t('report.autoGenerated')}  
> üïê ${t('report.generatedAt')}: ${new Date().toLocaleString()}`
})

// Ê†ºÂºèÂåñÂàÜÊûêÂÜÖÂÆπÔºå‰øùÊåÅ‰ª£Á†ÅÂùóÂíåÂàóË°®Ê†ºÂºè
const formatThoughtContent = (content: string) => {
  if (!content) return ''
  
  // Â§ÑÁêÜÂ§öË°åÂÜÖÂÆπÔºå‰øùÊåÅÂéüÊúâÁöÑÁªìÊûÑ
  return content
    .split('\n')
    .map(line => {
      // Â¶ÇÊûúË°å‰ª•ÁâπÊÆäÂ≠óÁ¨¶ÂºÄÂßãÔºåÂèØËÉΩÊòØÂàóË°®Êàñ‰ª£Á†Å
      if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
        return line
      }
      if (line.trim().startsWith('#')) {
        return line.replace(/^#+\s*/, '**') + '**'
      }
      return line
    })
    .join('\n')
}

// Ê†πÊçÆ‰ª£ÁêÜËé∑ÂèñÂØπÂ∫îÂõæÊ†á
const getAgentIcon = (agent: string) => {
  const icons: Record<string, string> = {
    // ‰∏≠Êñá
    'Á≥ªÁªü': 'üîß',
    'Â∏ÇÂú∫ÂàÜÊûêÂ∏à': 'üìä',
    'Êï∞ÊçÆÂàÜÊûê': 'üìà',
    'ÊäÄÊúØÂàÜÊûê': 'üîç',
    'ÊäïËµÑÂª∫ËÆÆ': 'üí°',
    'ÁªÑÂêàÁªèÁêÜ': 'üíº',
    'È£éÈô©ÁªèÁêÜ': '‚ö†Ô∏è',
    '‰∫§ÊòìÂëò': 'üíπ',
    // English
    'System': 'üîß',
    'Market Analyst': 'üìä',
    'News Analyst': 'üì∞',
    'Social Media Analyst': 'üì±',
    'Bear Researcher': 'üêª',
    'Bull Researcher': 'üêÇ',
    'Research Manager': 'üìã',
    'Portfolio Manager': 'üíº',
    'Risk Manager': '‚ö†Ô∏è',
    'Trader': 'üíπ'
  }
  return icons[agent] || 'ü§ñ'
}

// Ê†ºÂºèÂåñÊåÅÁª≠Êó∂Èó¥
const formatDuration = (duration: number | undefined) => {
  if (!duration) return t('report.duration.unknown')
  const seconds = Math.floor(duration / 1000)
  if (seconds < 60) {
    return t('report.duration.seconds', { seconds })
  } else {
    const minutes = Math.floor(seconds / 60)
    const remainingSeconds = seconds % 60
    return t('report.duration.minutesSeconds', { minutes, seconds: remainingSeconds })
  }
}

// ÂØºÂá∫ÊâìÂç∞ÊñπÊ≥ïÁªôÁà∂ÁªÑ‰ª∂‰ΩøÁî®
const print = () => {
  if (reportViewerRef.value) {
    reportViewerRef.value.print()
  }
}

// Êö¥Èú≤ÊñπÊ≥ïÁªôÁà∂ÁªÑ‰ª∂
defineExpose({ print })

</script>

<style scoped>
.simple-report {
  width: 100%;
  height: 100%;
}
</style>